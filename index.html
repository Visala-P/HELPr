<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HELPr</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div id="app">
    <div class="top-bar">
  <div class="top-bar-buttons">
    <button id="dark-toggle" title="Toggle Dark Mode">ğŸŒ™</button>
  </div>
  <div class="profile-icon" title="Your Account">
    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Profile" />
  </div>
</div>


    <aside class="sidebar">
      <div class="sidebar-header">HELPr</div>
      <nav class="sidebar-nav">
  <button class="sidebar-btn" onclick="startNewChat()">ğŸ“ New chat</button>
  <button class="sidebar-btn" onclick="toggleSearchSection()">ğŸ” Search chats</button>
  <button class="sidebar-btn">ğŸ–¼ï¸ Library</button>
  <button class="sidebar-btn" onclick="clearCurrentChat()">ğŸ—‘ï¸ Clear History</button>
  <button class="sidebar-btn" onclick="exportChatPDF()">ğŸ“¤ Export Chat</button> <!-- New line added -->
</nav>
      <div class="chat-history">
        <h4>Chats</h4>
        <ul id="chat-list"></ul>
      </div>
    </aside>

    <main class="chat-container">
      <div id="chat-messages" class="chat-messages"></div>

      <div id="search-section" style="display:none;">
        <input type="text" id="search-input" placeholder="Search chat history..." />
        <button onclick="searchChats()">Search</button>
        <div id="search-results"></div>
      </div>
<form id="chat-form">
  <div class="chat-input-wrapper">
    <div class="chat-left-icons">
      <button type="button" class="icon-btn" id="upload-btn" title="Attach File">+</button>
      <button type="button" class="icon-btn" id="mic-button" title="Speak">ğŸ™ï¸</button>
    </div>

    <textarea id="user-input" placeholder="Ask anything..." rows="1"></textarea>

    <div class="chat-right-icons">
      <button type="submit" id="send-button" title="Send">
        <span class="send-arrow">â¬†</span>
      </button>
    </div>
  </div>
  <input type="file" id="file-input" style="display:none;" />
</form>
  </div>
    <input type="file" id="file-input" accept="image/*,audio/*" multiple style="display:none;" />
      <div id="preview" class="preview"></div>
    </main>
  </div>
<script src="script.js">
    // Existing variables
let allChats = [], chatHistory = [], currentChatId = null;
let controller = null;
let isBotReplying = false;
const sessionId = localStorage.getItem('sessionId') || Date.now().toString();
localStorage.setItem('sessionId', sessionId);

const chatForm = document.getElementById("chat-form");
const inputBox = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");
const sendIcon = document.getElementById("send-icon");
const micIcon = document.getElementById("mic-icon");
 const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const taskSelect = document.getElementById('task');

// Handle file upload from button click
document.getElementById("upload-btn").addEventListener("click", () => {
  document.getElementById("file-input").click();
});

// ğŸ–¼ï¸ File Upload Handler (camera/gallery/file)
document.getElementById("file-input").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  if (file.type.startsWith("image/")) {
    handleImageUpload(file);
  } else if (file.name.endsWith(".py")) {
    const reader = new FileReader();
    reader.onload = function () {
      appendMessage("user", `ğŸ“ Uploaded Python File: <pre><code class="language-python">${reader.result}</code></pre>`, new Date().toLocaleTimeString());
      Prism.highlightAll();
    };
    reader.readAsText(file);
  } else {
    alert("Only images or .py files allowed.");
  }
});

// ğŸ“‹ Clipboard Image Paste Support
inputBox.addEventListener("paste", (event) => {
  const items = (event.clipboardData || window.clipboardData).items;
  for (const item of items) {
    if (item.type.indexOf("image") !== -1) {
      const file = item.getAsFile();
      handleImageUpload(file);
    }
  }
});

// ğŸ–±ï¸ Drag & Drop Support (Desktop)
document.addEventListener("dragover", (e) => e.preventDefault());
document.addEventListener("drop", (e) => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith("image/")) {
    handleImageUpload(file);
  }
});

  imageInput.addEventListener('change', () => {
      const files = Array.from(imageInput.files);
      preview.innerHTML = '';
      if (files.length > 5) {
        alert('âš ï¸ You can only upload up to 5 files.');
        imageInput.value = '';
        return;
      }
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const el = document.createElement(file.type.startsWith('audio/') ? 'div' : 'img');
          if (file.type.startsWith('audio/')) {
            el.textContent = `ğŸ§ Audio file: ${file.name}`;
          } else {
            el.src = e.target.result;
            el.style.maxWidth = '200px';
          }
          el.style.margin = '10px';
          preview.appendChild(el);
        };
        reader.readAsDataURL(file);
      });
   uploadImagesToNodeServer(files);
    });

    async function submitFiles() {
      const files = Array.from(imageInput.files);
      const task = taskSelect.value;
      if (!files.length) return alert("Please select at least one file.");

      const formData = new FormData();
      if (task === 'transcribe') {
        // Only use first audio file
        const audioFile = files.find(f => f.type.startsWith('audio/'));
        if (!audioFile) return alert('ğŸ™ï¸ Please select an audio file.');
        formData.append('audio', audioFile);
      } else {
        const imageFiles = files.filter(f => f.type.startsWith('image/'));
        if (!imageFiles.length) return alert('ğŸ“· Please select at least one image.');
        imageFiles.forEach(f => formData.append('image', f));
      }

      const endpoints = {
        detect: 'http://localhost:5000/detect',
        ocr: 'http://localhost:5000/ocr',
        transcribe: 'http://localhost:5000/transcribe'
      };
      const endpoint = endpoints[task];

      try {
        const res = await fetch(endpoint, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(await res.text());

        if (task === 'detect' || task === 'transcribe') {
          const data = await res.json();
          console.log('ğŸ“ Result:', data);
          alert(JSON.stringify(data, null, 2));
        } else if (task === 'ocr') {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
        }
      } catch (err) {
        console.error(err);
        alert('âŒ Task failed: ' + err.message);
      }
    }
 window.addEventListener('load', () => {
    scrollToBottom(); // Scroll to the bottom on page load
  });

  function scrollToBottom() {
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  }

  // Example: Call this function every time you append a message dynamically
  function appendMessage(content) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    messageDiv.textContent = content;
    chatMessages.appendChild(messageDiv);

    scrollToBottom(); // Scroll after message is added
  }
  </script>
  <!-- Updated File Input for Camera/Gallery/File -->
   

</body>
</html>
